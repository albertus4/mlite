<div class="row">
    <form action="{?=url(ADMIN.'/orthanc/saveSettings')?}" method="POST">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Pengaturan API Orthanc</h3>
                </div>
            	  <div class="panel-body">
                    <div class="form-group">
                        <label>Orthanc Server</label>
                        <input type="text" name="orthanc[server]" class="form-control" value="{$orthanc.server}" placeholder="http://localhost:8042" />
                        <small class="help-block">URL lengkap server Orthanc termasuk port</small>
                    </div>
                    <div class="form-group">
                        <label>Orthanc Username</label>
                        <input type="text" name="orthanc[username]" class="form-control" value="{$orthanc.username}" />
                    </div>
                    <div class="form-group">
                        <label>Orthanc Password</label>
                        <input type="password" name="orthanc[password]" class="form-control" value="{$orthanc.password}" />
                    </div>
                    <div class="form-group">
                        <input type="submit" name="save" class="btn btn-primary" value="Simpan" />
                        <button type="button" id="test-connection" class="btn btn-info" style="margin-left: 10px;">
                            <i class="fa fa-plug"></i> Test Koneksi
                        </button>
                    </div>
                    <div id="connection-result" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<script type="text/javascript">
$(document).ready(function() {
    $('#test-connection').click(function() {
        var server = $('input[name="orthanc[server]"]').val();
        var username = $('input[name="orthanc[username]"]').val();
        var password = $('input[name="orthanc[password]"]').val();
        
        if (!server || !username || !password) {
            $('#connection-result').html('<div class="alert alert-warning"><i class="fa fa-warning"></i> Silakan isi semua field terlebih dahulu.</div>');
            return;
        }
        
        $('#test-connection').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Testing...');
        $('#connection-result').html('<div class="alert alert-info"><i class="fa fa-spinner fa-spin"></i> Sedang menguji koneksi...</div>');
        
        var baseURL = mlite.url + '/' + mlite.admin;
        var url = baseURL + '/orthanc/testconnection?t=' + mlite.token;
        
        $.ajax({
            url: url,
            method: 'POST',
            data: {
                server: server,
                username: username,
                password: password
            },
            dataType: 'JSON',
            success: function(response) {
                if (response.success) {
                    var html = '<div class="alert alert-success">';
                    html += '<i class="fa fa-check-circle"></i> <strong>Koneksi Berhasil!</strong><br>';
                    html += 'Server: ' + (response.data.name || 'Orthanc') + '<br>';
                    html += 'Version: ' + (response.data.version || 'Unknown');
                    html += '</div>';
                    $('#connection-result').html(html);
                } else {
                    var html = '<div class="alert alert-danger">';
                    html += '<i class="fa fa-times-circle"></i> <strong>Koneksi Gagal!</strong><br>';
                    html += 'Error: ' + response.message + '<br>';
                    if (response.troubleshooting) {
                        html += '<small><strong>Troubleshooting:</strong> ' + response.troubleshooting + '</small>';
                    }
                    html += '</div>';
                    $('#connection-result').html(html);
                }
            },
            error: function(xhr, status, error) {
                $('#connection-result').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> <strong>Error:</strong> ' + error + '</div>');
            },
            complete: function() {
                $('#test-connection').prop('disabled', false).html('<i class="fa fa-plug"></i> Test Koneksi');
            }
        });
    });
});
</script>
