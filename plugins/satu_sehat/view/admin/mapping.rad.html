<style>
    .nowrap th, .nowrap td {
      white-space: nowrap;
    }
    .selected {
        background-color: #d0ebff !important;
    }    
</style>
<h4>Mapping Radiologi Satu Sehat</h4>
<form action="{?=url(ADMIN.'/satu_sehat/saverad')?}" method="POST">
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Pilih Jenis Perawatan</label>
                        <select name="kd_jenis_prw" id="kd_jenis_prw" class="form-control" data-use-search="true">
                            {loop: $jns_perawatan_radiologi}
                            <option value="{$value.kd_jenis_prw}">[{$value.kd_jenis_prw}] - {$value.nm_perawatan}</option>
                            {/loop}
                        </select>
                    </div>
                    <div class="form-group">
                        <p>
                            <label>Terminologi Loinc Radiologi</label>
                            <select id="select_rad" name="select_rad" class="form-control" placeholder="Silahkan cari terminologi..."></select>
                        </p>
                        <div id="detail_rad"></div>
                    </div>
                </div>
                <div class="col-md-12" style="padding-top: 20px;">
                    <input type="submit" name="simpan" class="btn btn-success" value="Simpan" />
                    <input type="submit" name="hapus" class="btn btn-danger" value="Hapus" />
                </div>
            </div>
        </div>
    </div>
</form>
<div class="row">
<div class="col-md-12">
    <div class="table-responsive no-margin" id="mapping_rad_satu_sehat">
    <table class="table table-striped table-bordered no-padding nowrap dataTables" width="100%">
        <thead>
        <tr>
            <th>Kode Perawatan</th>
            <th>Nama Perawatan</th>
            <th>Code</th>
            <th>Display</th>
            <th>Sample Code</th>
            <th>Sample System</th>
            <th>Sample Display</th>
        </tr>
        </thead>
        <tbody>
        {loop: $mapping_rad_satu_sehat}
        <tr class="mapping_rad_satu_sehat"
        data-kd_jenis_prw="{$value.kd_jenis_prw}"
        >
            <td>{$value.kd_jenis_prw}</td>
            <td>{$value.nm_perawatan}</td>
            <td>{$value.code}</td>
            <td>{$value.display}</td>
            <td>{?=isset_or($value.sample_code,'')?}</td>
            <td>{?=isset_or($value.sample_system,'')?}</td>
            <td>{?=isset_or($value.sample_display,'')?}</td>
        </tr>
        {/loop}
        </tbody>
    </table>
    </div>
</div>
</div>
<script type="text/javascript">
$('.dataTables').DataTable();

$('#mapping_rad_satu_sehat table tbody').on('click', 'tr.mapping_rad_satu_sehat', function() {
    // Remove selection from other rows
    $('#mapping_rad_satu_sehat table tbody tr').removeClass('selected');

    // Add selected class to clicked row
    $(this).addClass('selected');

    // Example: Get data attribute
    var kd_jenis_prw = $(this).data('kd_jenis_prw');
    $('#kd_jenis_prw').val(kd_jenis_prw).change();
    console.log('Selected Kode Jenis Perawatan:', kd_jenis_prw);
});

$('input[name="hapus"]').on('click', function (e) {
    const confirmDelete = confirm('Apakah Anda yakin ingin menghapus data ini?');
    if (!confirmDelete) {
        e.preventDefault(); // Batalkan submit jika tidak disetujui
    }
});

var strip_tags = function(str) {
    return (str + '').replace(/<\/?[^>]+(>|$)/g, '')
};
var truncate_string = function(str, chars) {
    if ($.trim(str).length <= chars) {
        return str;
    } else {
        return $.trim(str.substr(0, chars)) + 'â€¦';
    }
};
var $select = $('#select_rad');
const url = 'https://basoro.id/downloads/LoincRadiologi.json';
$select.selectator({
    labels: {
        search: 'Search here...'
    },
    load: function (search, callback) {
      if (search.length < 5) {
        callback([{ value: '', text: 'Ketik minimal 3 huruf...' }]);
        return;
      }

      fetch(url)
        .then(res => res.json())
        .then(data => {
          dataRad = data; // Simpan data di variabel global
          console.log(dataRad);
          const filtered = data.filter(item =>
            item.Nama_Pemeriksaan && item.Nama_Pemeriksaan.toLowerCase().includes(search.toLowerCase())
          );

          const options = filtered.map(item => ({
            value: item.Code,
            text: item.Nama_Pemeriksaan,
            subtext: `Sample Code: ${item.Body_Site_Code || '-'} | Sample Display: ${item.Body_Site_Display || '-'}`
          }));

          callback(options.slice(0, 100)); // Batasi maksimal 100 hasil
        })
        .catch(err => {
          console.error('Gagal mengambil data:', err);
          callback([]);
        });
    },
    delay: 300,
    minSearchLength: 5,
    valueField: 'value',
    textField: 'text',
    render: {
        option: function (_item, escape) {
            var html = '';
            html += '<div class="selectator_option_title">' + ((typeof _item.text !== 'undefined') ? _item.text : '') + '</div>';
            html += '<div class="selectator_option_subtitle">' + ((typeof _item.subtext !== 'undefined') ? truncate_string(escape(strip_tags(_item.subtext)), 75) : '') + '</div>';
            return html;
        }
    }

});

$('#select_rad').on('change', function () {
    const kodeRad = $(this).val();
    if (!kodeRad) return;

    // Cari detail di dataKFA berdasarkan kodeKFA
    const detail = dataRad.find(item => item.Code.toString() === kodeRad.toString());

    if (detail) {
        console.log('Detail lengkap rad:', detail);
        $('#detail_rad').html(`
        <p><label>Kode</label><input type="text" name="code" class="form-control" value="${detail.Code}"></p>
        <p><label>Nama Pemeriksaan</label><input type="text" name="display" class="form-control" value="${detail.Nama_Pemeriksaan}"></p>
        <p><label>Code System</label><input type="text" name="code_system" class="form-control" value="${detail.Code_System}"></p>
        <p><label>Sample Code</label>
            <div class="input-group">
                <input type="text" name="sample_code" id="sample_code" class="form-control" value="">
                <span class="input-group-btn">
                    <button type="button" id="AIGenerateSampleCode" class="btn btn-primary" title="Generate Sample Code dengan AI">
                        <i class="fas fa-robot"></i> AI Generate
                    </button>
                </span>
            </div>
        </p>
        <p><label>Sample Display</label><input type="text" name="sample_display" id="sample_display" class="form-control" value=""></p>
        <p><label>Sample System</label><input type="text" name="sample_system" id="sample_system" class="form-control" value=""></p>
        `);
        
        function setupAIGenerateButton() {
            $('#AIGenerateSampleCode').off('click').on('click', function() {
                const displayName = $('input[name="display"]').val() || '';
                const code = $('input[name="code"]').val() || '';
                const originalText = $(this).html();
                $(this).html('<i class="fa fa-spinner fa-spin"></i> Generating...').prop('disabled', true);

                const apiKey = '';
                const requestData = {
                    model: "openai/gpt-4o",
                    messages: [
                        {
                            role: "user",
                            content: `Buatkan resource FHIR Specimen (JSON) untuk pemeriksaan radiologi "${displayName}" dengan kode LOINC ${code}. Struktur WAJIB: resourceType="Specimen", id="{specimen_id}", type.coding (array) dengan system="http://snomed.info/sct", code, dan display; subject.reference="Patient/{patient_id}"; collection.collectedDateTime dalam format ISO8601 (contoh: "2025-10-06T07:45:00+08:00"). Isi code dan display sesuai sampel anatomi radiologi yang relevan. Balas HANYA dengan objek JSON mentah tanpa backticks/label/teks tambahan.`
                        }
                    ]
                };

                fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const responseContent = (data.choices[0].message.content || '').trim();

                        const extractJSONBlock = (text) => {
                            const fenced = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
                            const raw = fenced ? fenced[1].trim() : text;
                            const start = raw.indexOf('{');
                            const end = raw.lastIndexOf('}');
                            if (start !== -1 && end !== -1 && end > start) {
                                const candidate = raw.slice(start, end + 1);
                                try { return JSON.parse(candidate); } catch (e) {}
                            }
                            try { return JSON.parse(raw); } catch (e) { return null; }
                        };

                        const specimenData = extractJSONBlock(responseContent);

                        if (specimenData && specimenData.type && specimenData.type.coding && specimenData.type.coding[0]) {
                            const coding = specimenData.type.coding[0];
                            const sanitize = (s) => (typeof s === 'string' ? s.replace(/`/g, '').trim() : s);
                            $('input[name="sample_code"]').val(coding.code || '');
                            $('input[name="sample_display"]').val(coding.display || '');
                            $('input[name="sample_system"]').val(sanitize(coding.system) || '');
                            alert('Data Specimen berhasil di-generate!');
                        } else {
                            throw new Error('Struktur JSON Specimen tidak valid atau field coding tidak ditemukan');
                        }
                    } else {
                        throw new Error('Invalid response format from API');
                    }
                })
                .catch(error => {
                    alert('Gagal generate sample code: ' + error.message);
                })
                .finally(() => {
                    $(this).html(originalText).prop('disabled', false);
                });
            });
        }
        
        // Setup AI Generate button after detail is loaded
        setupAIGenerateButton();
    }
});

</script>
  