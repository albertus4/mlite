# mLITE Docker PHP 7.4 Environment
# Compatible with mLITE PHP 7.4 requirements
FROM php:7.4-fpm

# Install system dependencies required for mLITE
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libjpeg-dev \
    libonig-dev \
    libxml2-dev \
    libzip-dev \
    libicu-dev \
    libfreetype6-dev \
    zip \
    unzip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install PHP extensions required by mLITE
RUN docker-php-ext-install \
    pdo_mysql \
    mysqli \
    mbstring \
    exif \
    pcntl \
    bcmath \
    gd \
    intl \
    zip \
    opcache

RUN docker-php-ext-enable mysqli

# Configure GD extension with FreeType and JPEG support
RUN docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install -j$(nproc) gd

# Install Redis and Xdebug via PECL
RUN pecl install redis && docker-php-ext-enable redis
# Xdebug 3.1.5 is the last compatible with PHP 7.4
RUN pecl install xdebug-3.1.5 && docker-php-ext-enable xdebug

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Copy custom PHP configuration
COPY ./php/php.ini /usr/local/etc/php/conf.d/custom.ini

# Working directory
WORKDIR /var/www/public

# Entrypoint
COPY ./php/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

# Expose PHP-FPM port
EXPOSE 9000